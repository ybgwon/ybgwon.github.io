<!doctype html><html lang=en><head><title>YB Gwon's ...</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="YB Gwon's blog for creative and technical writing."><meta name=author content="[Yong-Beom Gwon]"><meta name=generator content="Hugo 0.60.1"><meta property="og:title" content="Posts"><meta property="og:description" content="YB Gwon's blog for creative and technical writing."><meta property="og:type" content="website"><meta property="og:url" content="/posts/"><meta property="og:updated_time" content="2019-12-05T19:37:00+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Posts"><meta name=twitter:description content="YB Gwon's blog for creative and technical writing."><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css><script src=https://kit.fontawesome.com/b76b73e8e8.js crossorigin=anonymous></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans+KR|Roboto|Ruda"><link rel=stylesheet type=text/css href=/css/styles.css><link rel=stylesheet href=/css/style.css></head><body><div id=container><header><h1><a href=/>YB Gwon's &mldr;</a></h1><ul id=social-media><li><a href=https://github.com/ybgwon title=GitHub><i class="fab fa-github fa-lg"></i></a></li></ul><p><em>Personal Blog for creative and technical writing</em></p></header><nav><ul><li><a href=/posts/><i class="fa-li fa fa-lg"></i><span>Posts</span></a></li><li><a href=/about/><i class="fa-li fa fa-lg"></i><span>About Hugo</span></a></li></ul></nav><main><article><h1>Kernel-Study-2019-11-16</h1><aside><ul><li><time class=post-date datetime=2019-11-16T15:40:00+09:00>Nov 16, 2019</time></li><li>2 minutes read</li></ul></aside><h2 id=주요-코드>주요 코드</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>arch_local_irq_disable</span>(<span style=color:#66d9ef>void</span>)
{
      <span style=color:#66d9ef>asm</span> <span style=color:#66d9ef>volatile</span>(ALTERNATIVE(
	      <span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>msr	daifset, #2		// arch_local_irq_disable</span><span style=color:#e6db74>&#34;</span>,
	      <span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>msr_s  </span><span style=color:#e6db74>&#34;</span> __stringify(SYS_ICC_PMR_EL1) <span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>, %0</span><span style=color:#e6db74>&#34;</span>,
	      ARM64_HAS_IRQ_PRIO_MASKING)
	      <span style=color:#f92672>:</span>
	      <span style=color:#f92672>:</span> <span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;</span> ((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>) GIC_PRIO_IRQOFF)
	      <span style=color:#f92672>:</span> <span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>memory</span><span style=color:#e6db74>&#34;</span>);
}
</code></pre></div><h2 id=daif-레지스터>DAIF 레지스터</h2><p>Interrupt Mask Bit. interrupt mask bits에 억세스 할 수 있도록 한다.<br>ARMv8-A_Architecture_Reference_Manual_(Issue_A.a) - C4.3.2</p><figure><a href=/images/daif-1.png><img src=/images/daif-1.png></a></figure><figure><a href=/images/daif-2.png><img src=/images/daif-2.png></a></figure><h3 id=pstate-fields-접근-명령>PSTATE fields 접근 명령</h3><ul><li><p>daifset</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>MSR DAIFSet, #Imm4    ; Used to set any or all of DAIF to 1
</code></pre></div></li></ul><h2 id=alternative-매크로>ALTERNATIVE 매크로</h2><p>ARM에서는 ALTERNATIVE 기능이 적용되지 않았다.<br>ARM64의 경우 ARMv8.1 코드와 ARMv8.2 코드를 준비해두고 부트업시<br>cpu capabilities(features)를 확인하여 가능하면 성능이 더 좋은<br>ARMv8.2 코드로 replacement 하도록 사용한다.</p><h2 id=asm-volatile-사용법>asm volatile 사용법</h2><p>kernel 코드에서 자주 나오는 inline asembly이다</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>__asm__ <span style=color:#a6e22e>__volatile__</span> (asms : output : input : clobber);  
</code></pre></div><ul><li><p>asm<br>다음에 나오는 것이 인라인 어샘블리 임을 나타낸다</p></li><li><p>volatile<br>최적화를 하지 않는다.</p></li><li><p>asms<br>따옴표로 둘러싸인 어셈블리 코드. %x 와 같은 형태로 input, output<br>파라메터 사용</p></li><li><p>output<br>결과값을 출력하는 변수. 쉼표로 구분</p></li><li><p>input<br>인라인 어셈블리 코드에 넘겨주는 파라메터</p></li><li><p>clobber<br>값이 바뀌는 레지스터. 각 변수는 쉼표로 구분되고 각각을 따옴표로 감싼다.</p></li></ul><p>output input clobber 는 마지막이 없으면 앞의 &lsquo;:&lsquo;를 생략할 수있으나 중간에 것이 없으면 반드시 콜론을 표기 해야 한다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#75715e>#include &lt;stdio.h&gt;
</span><span style=color:#75715e></span>
<span style=color:#a6e22e>int</span> <span style=color:#66d9ef>main</span>(<span style=color:#66d9ef>void</span>)
<span style=color:#960050;background-color:#1e0010>{</span>
      <span style=color:#a6e22e>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>a</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#ae81ff>5</span><span style=color:#75715e>;
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>b</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#ae81ff>10</span><span style=color:#75715e>;
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>sum</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#ae81ff>0</span><span style=color:#75715e>;
</span><span style=color:#75715e></span>
      <span style=color:#a6e22e>__asm__</span>(<span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>addq</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#ae81ff>1</span>,<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>&#34;</span> : <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#960050;background-color:#1e0010>=</span><span style=color:#66d9ef>r</span><span style=color:#960050;background-color:#1e0010>&#34;</span> (<span style=color:#66d9ef>sum</span>) : <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>r</span><span style=color:#960050;background-color:#1e0010>&#34;</span> (<span style=color:#66d9ef>a</span>), <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&#34;</span> (<span style=color:#66d9ef>b</span>))<span style=color:#75715e>;
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>printf</span>(<span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>a</span> <span style=color:#960050;background-color:#1e0010>+</span> <span style=color:#66d9ef>b</span> <span style=color:#960050;background-color:#1e0010>=</span> %lu<span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>n</span><span style=color:#960050;background-color:#1e0010>&#34;</span>, <span style=color:#66d9ef>sum</span>)<span style=color:#75715e>;
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span><span style=color:#75715e>;
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>}</span>
</code></pre></div><p>__asm__(&ldquo;addq %1,%2&rdquo; : &ldquo;=r&rdquo; (sum) : &ldquo;r&rdquo; (a), &ldquo;0&rdquo; (b));<br>위 코드에서 asm 부분만 따로 떼어 내서 분석해 보면</p><h3 id=어셈블리-코드>어셈블리 코드</h3><p>&ldquo;addq %1,%2&rdquo;<br>%1,%2 는 output operands 부터 좌측에서 순서대로 0번 부터 매겨지는레지스터 변수의 순서이다.<br>위의 경우는 sum 부분의 레지스터가 0번이다. 그리고 a는 1, b는 2 번순으로 된다. b의 경우는 다시 &ldquo;0"으로 표기하여 output 의 0번째<br>sum 부분 레지스터를 사용하게 되어 sum 부분 레지스터는 재사용하게 된다.</p><h3 id=input-operands--입력-인수--and-output-operands--출력-인수>Input Operands(입력 인수) & Output Operands(출력 인수)</h3><ul><li><p>형식</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[ [asmSymbolicName] ] constraint (C-expression)
</code></pre></div></li></ul><h4 id=asmsymbolicname>asmSymbolicName</h4><p>생략 가능하고 지정하는 경우 %0, %1, …과 같이 인수의 순번을사용하는 대신 심볼명을 사용할 수도 있다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#a6e22e>asm</span> (<span style=color:#960050;background-color:#1e0010>“</span><span style=color:#66d9ef>add</span> <span style=color:#960050;background-color:#1e0010>%</span>[<span style=color:#66d9ef>tmp</span>], <span style=color:#75715e>#2” : [tmp] “=r” (tmp));
</span></code></pre></div><h4 id=constraint>constraint</h4><p>&ldquo;=r&rdquo; 또는 &ldquo;0&rdquo;</p><p><code>=r</code> 에서 <code>=</code> 은 modifier 가 되고 r이 일반 레지스터를나타내는 contraint 이다.</p><ol><li>&lsquo;r&rsquo; - 일반 레지스터</li><li>&lsquo;m&rsquo; - 유효 메모리 주소</li><li>&lsquo;[digits]&rsquo; - Output Operands에서 숫자 번째 항목</li></ol><h4 id=modifier>modifier</h4><ol><li>&lsquo;=&rsquo; - 쓰기 전용</li><li>&lsquo;+&rsquo; - 읽기 쓰기</li><li>&lsquo;&&rsquo; - OutputOperands에서 레지스터 할당 순서를 먼저 할 수있도록 요청.<br>보통 input operands에 레지스터를 할당하고 그 후<br>output operands의 레지스터를 사용하기 때문에 input operands에서사용했던 레지스터를 output operands 레지스터로 배치하는경우도 생기는데 그러면서 문제가 될 수 있는 곳에 사용</li></ol><h2 id=참조>참조</h2><p><a href=https://wiki.kldp.org/KoreanDoc/html/EmbeddedKernel-KLDP/app3.basic.html>kldp</a><br><a href="https://0xax.gitbooks.io/linux-insides/content/Theory/linux-theory-3.html?q=">linux inside</a><br><a href=http://jake.dothome.co.kr/inline-assembly/>http://jake.dothome.co.kr/inline-assembly/</a></p></article><section class=post-nav><ul><li><a href=/posts/hugo-%EC%82%AC%EC%9A%A9%EB%B2%95/><i class="fa fa-chevron-circle-left"></i>hugo 사용법</a></li><li><a href=/posts/kernel-study-2019-11-23/>kernel-study-2019-11-23 <i class="fa fa-chevron-circle-right"></i></a></li></ul></section><section class=comments-block><button id=show-comments style=display:none><i class="fa fa-comments"></i></button></section><section id=disqus_thread></section><script>(function(){if(window.location.hostname=="localhost")
return;var disqus_loaded=false;var disqus_shortname='ybgwon';var disqus_button=document.getElementById("show-comments");disqus_button.style.display="";disqus_button.addEventListener("click",disqus,false);function disqus(){if(!disqus_loaded){disqus_loaded=true;var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e);document.getElementById("show-comments").style.display="none";}}
var hash=window.location.hash.substr(1);if(hash.length>8){if(hash.substring(0,8)=="comment-"){disqus();}}
if(/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)){disqus();}})();</script></main><footer><h6>Copyright © 2019 - ybgwon |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=/index.xml>Subscribe</a></h6></footer></div><script src=/js/scripts.js></script></body></html>